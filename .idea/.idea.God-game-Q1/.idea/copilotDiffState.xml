<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/TILEMAP_HEIGHT_OPTIMIZATION.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/TILEMAP_HEIGHT_OPTIMIZATION.md" />
              <option name="updatedContent" value="# TilemapManager Height System Optimization&#10;&#10;## Date&#10;December 5, 2025&#10;&#10;## Problem&#10;The original implementation was **extremely inefficient** when getting column heights:&#10;- **O(n) complexity** - iterated through ALL tiles every time `GetColumnHeight()` was called&#10;- With thousands of tiles, this caused massive performance issues&#10;- When placing many tiles per tick (brush painting), this multiplied the problem&#10;&#10;## Solution&#10;Added a separate `columnHeights` dictionary to track the maximum height of each column.&#10;&#10;### New Data Structure&#10;```csharp&#10;private Dictionary&lt;Vector2Int, int&gt; columnHeights = new();&#10;```&#10;- **Key**: `Vector2Int(q, r)` - the hex coordinates&#10;- **Value**: `int` - the next available height (current max height + 1)&#10;&#10;## Performance Improvement&#10;&#10;### Before (O(n))&#10;```csharp&#10;public int GetColumnHeight(int q, int r)&#10;{&#10;    int maxZ = 0;&#10;    foreach (var kvp in tiles) // Iterates through ALL tiles&#10;    {&#10;        Vector3Int key = kvp.Key;&#10;        if (key.x == q &amp;&amp; key.y == r)&#10;        {&#10;            if (key.z &gt;= maxZ)&#10;            {&#10;                maxZ = key.z + 1;&#10;            }&#10;        }&#10;    }&#10;    return maxZ;&#10;}&#10;```&#10;- **Complexity**: O(n) where n = total number of tiles in the scene&#10;- **Example**: With 10,000 tiles, checking 100 columns = 1,000,000 comparisons&#10;&#10;### After (O(1))&#10;```csharp&#10;public int GetColumnHeight(int q, int r)&#10;{&#10;    Vector2Int key = new Vector2Int(q, r);&#10;    return columnHeights.TryGetValue(key, out int height) ? height : 0;&#10;}&#10;```&#10;- **Complexity**: O(1) - constant time dictionary lookup&#10;- **Example**: With 10,000 tiles, checking 100 columns = 100 lookups&#10;&#10;## Speed Improvement&#10;- **Theoretical**: 10,000x faster for 10,000 tiles&#10;- **Practical**: Instant lookups regardless of tile count&#10;&#10;## Implementation Details&#10;&#10;### 1. SpawnTileAt() Updates&#10;```csharp&#10;// Update column height tracker&#10;Vector2Int columnKey = new Vector2Int(hexCoords.x, hexCoords.y);&#10;int newHeight = hexCoords.z + 1; // +1 because z is 0-indexed&#10;if (!columnHeights.ContainsKey(columnKey) || columnHeights[columnKey] &lt; newHeight)&#10;{&#10;    columnHeights[columnKey] = newHeight;&#10;}&#10;```&#10;- When a tile is spawned, update the column height if necessary&#10;- Only updates if the new tile is taller than existing height&#10;&#10;### 2. RemoveColumn() Updates&#10;```csharp&#10;// Update column height tracker - remove the column entry&#10;Vector2Int columnKey = new Vector2Int(q, r);&#10;columnHeights.Remove(columnKey);&#10;```&#10;- When an entire column is removed, delete the height entry&#10;- The column height will be recalculated if tiles are added later&#10;&#10;## Memory Trade-off&#10;- **Additional Memory**: ~12 bytes per unique column (Vector2Int + int)&#10;- **Example**: 1,000 columns = ~12 KB&#10;- **Benefit**: Massive performance improvement for negligible memory cost&#10;&#10;## Edge Cases Handled&#10;1. **New column**: Returns 0 (spawn at ground level)&#10;2. **Removed column**: Entry deleted, returns 0 for next spawn&#10;3. **Partial column removal**: Not currently supported (would need recalculation)&#10;4. **Replace mode**: Removes entire column, resets height to 0&#10;&#10;## Future Optimizations (if needed)&#10;1. **Serialize columnHeights**: Save/load to avoid recalculation on scene load&#10;2. **Partial removal support**: Track individual tile removals and recalculate height&#10;3. **Height queries by range**: Add method to get all columns within a height range&#10;&#10;## Testing Notes&#10;- Place tiles with large brush sizes - should be instant now&#10;- Build tall columns - height tracking should be accurate&#10;- Replace columns - heights should reset correctly&#10;- Performance should scale with number of columns, not total tiles&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>